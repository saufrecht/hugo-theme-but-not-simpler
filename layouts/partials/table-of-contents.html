{{- $sorted_sibs := .Scratch.Get "sorted_sibs" -}}
{{- $this_page := . -}}
{{- $this_section := .CurrentSection -}}
{{- $parent := .Parent -}}
{{- $children :=  where .Pages "Params.notoc" "!=" true -}}
{{- $has_toc := false -}}

{{/* Hack: junk from an empty ToC is 32 char long .
TODO: presumably there's a better way to make it empty upstream? */}}

{{- if gt (len .TableOfContents) 32  -}}
  {{- $has_toc = true -}}  
{{- end -}}

{{- $sort := .Params.sort | default "" -}}
{{- if not $sort -}}
  {{- $sort = $.FirstSection.Params.sort | default "" -}}
{{- end -}}
{{- if (eq $sort "chron") -}}
  {{- $children = sort $children "Date"  -}}
{{- else if (eq $sort "rchron") -}}
  {{- $children = sort $children "Date" "desc" -}}
{{- else -}}
  {{- $children = sort $children "Title" -}}
{{- end -}}

{{- if $has_toc -}}
<ol>
  <li>
    <span>On this page</span>
    {{ .TableOfContents }}
  </li>
</ol>
{{- end -}}

{{/* TODO: check whether the … are actually appropriate */}}

<ol>
  <li>
    {{- if .IsHome -}}
      <span>Home</span>
      {{- partial "subsections" $children -}}
    {{- else -}}
      <a href="{{- $parent.RelPermalink -}}" title="Up to {{- partial "shorttitle" $parent }}">{{- partial "shorttitle" $parent }}</a>
      {{- if $sorted_sibs -}}
        <ol>
          <li>…</li>
          {{- range $sorted_sibs -}}
            {{- if eq .RelPermalink $this_page.RelPermalink -}}
              <li class="you-are-here">
                <span>{{- partial "shorttitle" . }}</span>
                {{- partial "subsections" $children -}}
              </li>
            {{- else -}}
              <li>
                <a href="{{- .RelPermalink -}}">{{- partial "shorttitle" . }}</a>
              </li>
            {{- end -}}
          {{- end -}} 
          <li>…</li>
        </ol>
      {{- end -}}
    {{- end -}}
  </li>
</ol>
