{{- $children :=  where .Pages "Params.notoc" "!=" true -}}

{{/* Hack: junk from an empty ToC is 32 char long 
presumably there's a better way to make it empty upstream? */}}

{{- $has_toc := false -}}
{{- if gt (len .TableOfContents) 32  -}}
  {{- $has_toc = true -}}  
{{- end -}}

{{- $sort := $.FirstSection.Params.sort | default "" -}}
{{- if (eq $sort "rchron") -}}
  {{- $children = sort $children "Date"  -}}
{{- else -}}
  {{- $children = sort $children "Title" -}}
{{- end -}}

{{- partial "shorttitle" . -}}

{{- if (and $has_toc $children) -}}
<ol>
  <li>
  On this page
  {{ .TableOfContents }}
  </li>
  <li>
  Sections
    {{- range $children -}}
      <li><a href="{{- .RelPermalink -}}">{{- partial "shorttitle" . }}</a></li>
    {{- end -}}
  </li>
</ol>
{{- else if $has_toc -}}
<ol>
  {{ .TableOfContents }}
</ol>
{{- else if $children -}}
<ol>
  {{- range $children -}}
    <li><a href="{{- .RelPermalink -}}">{{- partial "shorttitle" . }}</a></li>
  {{- end -}}
</ol>
{{- end -}}
